<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Karatê - Gerenciamento de Academia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .main-system {
            display: none;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: white;
            color: #333;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .attendance-grid {
            overflow-x: auto;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .attendance-table th {
            background: #667eea;
            color: white;
        }

        .attendance-checkbox {
            width: 20px;
            height: 20px;
        }

        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .nav-tabs {
                justify-content: center;
            }
            
            .nav-tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="logo">🥋</div>
            <h2>Sistema Karatê</h2>
            <p style="margin-bottom: 30px; color: #666;">Gerenciamento de Academia</p>
            <form id="loginForm">
                <div class="input-group">
                    <label>Usuário</label>
                    <input type="text" id="username" placeholder="Digite seu usuário" required>
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha" required>
                </div>
                <button type="submit" class="btn">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="main-system">
        <div class="container">
            <div class="header">
                <div>
                    <h1>🥋 Sistema de Karatê</h1>
                    <p id="academyName">Academia de Karatê</p>
                </div>
                <button onclick="logout()" class="btn" style="width: auto;">Sair</button>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('general')">Cadastros Gerais</button>
                <button class="nav-tab" onclick="showTab('students')">Alunos</button>
                <button class="nav-tab" onclick="showTab('attendance')">Presenças</button>
                <button class="nav-tab" onclick="showTab('payments')">Mensalidades</button>
                <button class="nav-tab" onclick="showTab('equipment')">Empréstimos</button>
                <button class="nav-tab" onclick="showTab('exams')">Exames</button>
            </div>

            <!-- Aba Cadastros Gerais -->
            <div id="general" class="tab-content active">
                <h3>Cadastros Gerais da Academia</h3>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Nome da Academia</label>
                        <input type="text" id="academyNameInput" placeholder="Nome da academia">
                    </div>
                    <div class="input-group">
                        <label>CNPJ (Opcional)</label>
                        <input type="text" id="cnpj" placeholder="00.000.000/0000-00">
                    </div>
                    <div class="input-group">
                        <label>Logo da Academia</label>
                        <input type="file" id="academyLogo" accept="image/*">
                    </div>
                </div>
                <button onclick="saveGeneralData()" class="btn">Salvar Dados Gerais</button>
            </div>

            <!-- Aba Alunos -->
            <div id="students" class="tab-content">
                <h3>Cadastro de Alunos</h3>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Nome</label>
                        <input type="text" id="studentName" placeholder="Nome completo">
                    </div>
                    <div class="input-group">
                        <label>RG</label>
                        <input type="text" id="studentRG" placeholder="000.000.000-0">
                    </div>
                    <div class="input-group">
                        <label>Endereço</label>
                        <input type="text" id="studentAddress" placeholder="Endereço completo">
                    </div>
                    <div class="input-group">
                        <label>Data de Nascimento</label>
                        <input type="date" id="studentBirth">
                    </div>
                    <div class="input-group">
                        <label>Altura</label>
                        <input type="number" id="studentHeight" placeholder="Altura em cm" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Categoria</label>
                        <select id="studentCategory">
                            <option value="infantil">Infantil</option>
                            <option value="juvenil">Juvenil</option>
                            <option value="adulto">Adulto</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Faixa Atual</label>
                        <select id="studentBelt">
                            <option value="branca">Branca</option>
                            <option value="cinza">Cinza</option>
                            <option value="azul">Azul</option>
                            <option value="amarela">Amarela</option>
                            <option value="vermelha">Vermelha</option>
                            <option value="laranja">Laranja</option>
                            <option value="verde">Verde</option>
                            <option value="roxa">Roxa</option>
                            <option value="marrom2">Marrom 2</option>
                            <option value="marrom1">Marrom 1</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Data do Exame da Faixa Atual</label>
                        <input type="date" id="studentExamDate">
                    </div>
                </div>
                <button onclick="addStudent()" class="btn">Cadastrar Aluno</button>
                
                <div class="student-list" id="studentsList">
                    <h4>Alunos Cadastrados</h4>
                </div>
            </div>

            <!-- Aba Presenças -->
            <div id="attendance" class="tab-content">
                <h3>Controle de Presenças</h3>
                <div class="input-group" style="max-width: 300px;">
                    <label>Mês/Ano</label>
                    <input type="month" id="attendanceMonth" onchange="generateAttendanceTable()">
                </div>
                <div class="attendance-grid">
                    <table class="attendance-table" id="attendanceTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceBody">
                        </tbody>
                    </table>
                </div>
                <button onclick="saveAttendance()" class="btn">Salvar Presenças</button>
            </div>

            <!-- Aba Mensalidades -->
            <div id="payments" class="tab-content">
                <h3>Controle de Mensalidades</h3>
                <div id="paymentAlerts"></div>
                <div id="paymentsList"></div>
                <button onclick="checkPaymentAlerts()" class="btn">Verificar Vencimentos</button>
            </div>

            <!-- Aba Empréstimos -->
            <div id="equipment" class="tab-content">
                <h3>Controle de Empréstimos - Kimono e Faixa</h3>
                
                <!-- Cadastro de Equipamentos -->
                <div class="card" style="margin-bottom: 30px;">
                    <h4>Cadastrar Novo Equipamento</h4>
                    <div class="form-grid">
                        <div class="input-group">
                            <label>Tipo de Equipamento</label>
                            <select id="equipmentType">
                                <option value="kimono">Kimono</option>
                                <option value="faixa">Faixa</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Tamanho</label>
                            <select id="equipmentSize">
                                <option value="PP">PP</option>
                                <option value="P">P</option>
                                <option value="M">M</option>
                                <option value="G">G</option>
                                <option value="GG">GG</option>
                                <option value="XG">XG</option>
                            </select>
                        </div>
                        <div class="input-group" id="beltColorGroup" style="display: none;">
                            <label>Cor da Faixa</label>
                            <select id="beltColor">
                                <option value="branca">Branca</option>
                                <option value="cinza">Cinza</option>
                                <option value="azul">Azul</option>
                                <option value="amarela">Amarela</option>
                                <option value="vermelha">Vermelha</option>
                                <option value="laranja">Laranja</option>
                                <option value="verde">Verde</option>
                                <option value="roxa">Roxa</option>
                                <option value="marrom">Marrom</option>
                                <option value="preta">Preta</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Código/Número</label>
                            <input type="text" id="equipmentCode" placeholder="Ex: K001, F001">
                        </div>
                        <div class="input-group">
                            <label>Estado</label>
                            <select id="equipmentCondition">
                                <option value="novo">Novo</option>
                                <option value="bom">Bom</option>
                                <option value="regular">Regular</option>
                                <option value="ruim">Ruim</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addEquipment()" class="btn">Cadastrar Equipamento</button>
                </div>

                <!-- Novo Empréstimo -->
                <div class="card" style="margin-bottom: 30px;">
                    <h4>Novo Empréstimo</h4>
                    <div class="form-grid">
                        <div class="input-group">
                            <label>Aluno</label>
                            <select id="loanStudent">
                                <option value="">Selecione um aluno</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Equipamento Disponível</label>
                            <select id="availableEquipment">
                                <option value="">Selecione um equipamento</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Data de Empréstimo</label>
                            <input type="date" id="loanDate">
                        </div>
                        <div class="input-group">
                            <label>Data de Devolução Prevista</label>
                            <input type="date" id="returnDate">
                        </div>
                        <div class="input-group">
                            <label>Observações</label>
                            <input type="text" id="loanNotes" placeholder="Observações sobre o empréstimo">
                        </div>
                    </div>
                    <button onclick="createLoan()" class="btn">Registrar Empréstimo</button>
                </div>

                <!-- Empréstimos Ativos -->
                <div class="card">
                    <h4>Empréstimos Ativos</h4>
                    <div id="activeLoans"></div>
                </div>

                <!-- Histórico de Empréstimos -->
                <div class="card" style="margin-top: 20px;">
                    <h4>Histórico de Empréstimos</h4>
                    <div id="loanHistory"></div>
                </div>

                <!-- Inventário de Equipamentos -->
                <div class="card" style="margin-top: 20px;">
                    <h4>Inventário de Equipamentos</h4>
                    <div id="equipmentInventory"></div>
                </div>
            </div>

            <!-- Aba Exames -->
            <div id="exams" class="tab-content">
                <h3>Controle de Exames</h3>
                <div id="examsList"></div>
                <button onclick="checkExamEligibility()" class="btn">Verificar Elegibilidade para Exames</button>
            </div>
        </div>
    </div>

    <script>
        // Dados do sistema (simulando um banco de dados)
        let systemData = {
            academy: {},
            students: [],
            attendance: {},
            payments: {},
            exams: {},
            equipment: [],
            loans: []
        };

        const beltProgression = {
            'branca': { next: 'cinza', months: 3, value: 40.00 },
            'cinza': { next: 'azul', months: 3, value: 45.00 },
            'azul': { next: 'amarela', months: 3, value: 55.00 },
            'amarela': { next: 'vermelha', months: 3, value: 60.00 },
            'vermelha': { next: 'laranja', months: 6, value: 65.00 },
            'laranja': { next: 'verde', months: 9, value: 70.00 },
            'verde': { next: 'roxa', months: 9, value: 75.00 },
            'roxa': { next: 'marrom2', months: 12, value: 80.00 },
            'marrom2': { next: 'marrom1', months: 12, value: 90.00 }
        };

        // Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'karate123') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                loadSystemData();
            } else {
                alert('Usuário ou senha incorretos!');
            }
        });

        function logout() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainSystem').style.display = 'none';
        }

        function showTab(tabName) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Adicionar classe active na aba clicada
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Carregar dados específicos da aba
            if (tabName === 'attendance') {
                loadAttendanceTab();
            } else if (tabName === 'payments') {
                loadPaymentsTab();
            } else if (tabName === 'exams') {
                loadExamsTab();
            } else if (tabName === 'equipment') {
                loadEquipmentTab();
            }
        }

        function saveGeneralData() {
            systemData.academy = {
                name: document.getElementById('academyNameInput').value,
                cnpj: document.getElementById('cnpj').value,
                logo: document.getElementById('academyLogo').files[0]?.name || ''
            };
            
            document.getElementById('academyName').textContent = systemData.academy.name || 'Academia de Karatê';
            alert('Dados gerais salvos com sucesso!');
        }

        function addStudent() {
            const student = {
                id: Date.now(),
                name: document.getElementById('studentName').value,
                rg: document.getElementById('studentRG').value,
                address: document.getElementById('studentAddress').value,
                birth: document.getElementById('studentBirth').value,
                height: document.getElementById('studentHeight').value,
                category: document.getElementById('studentCategory').value,
                belt: document.getElementById('studentBelt').value,
                examDate: document.getElementById('studentExamDate').value
            };
            
            if (!student.name || !student.rg || !student.birth) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            systemData.students.push(student);
            updateStudentsList();
            clearStudentForm();
            alert('Aluno cadastrado com sucesso!');
        }

        function clearStudentForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentRG').value = '';
            document.getElementById('studentAddress').value = '';
            document.getElementById('studentBirth').value = '';
            document.getElementById('studentHeight').value = '';
            document.getElementById('studentCategory').value = 'infantil';
            document.getElementById('studentBelt').value = 'branca';
            document.getElementById('studentExamDate').value = '';
        }

        function updateStudentsList() {
            const list = document.getElementById('studentsList');
            list.innerHTML = '<h4>Alunos Cadastrados</h4>';
            
            systemData.students.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'student-item';
                studentDiv.innerHTML = `
                    <strong>${student.name}</strong><br>
                    RG: ${student.rg} | Faixa: ${student.belt.charAt(0).toUpperCase() + student.belt.slice(1)}<br>
                    Nascimento: ${new Date(student.birth).toLocaleDateString('pt-BR')}
                `;
                list.appendChild(studentDiv);
            });
        }

        function loadAttendanceTab() {
            const currentDate = new Date();
            const currentMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
            document.getElementById('attendanceMonth').value = currentMonth;
            generateAttendanceTable();
        }

        function generateAttendanceTable() {
            const monthInput = document.getElementById('attendanceMonth').value;
            if (!monthInput) return;
            
            const [year, month] = monthInput.split('-');
            const daysInMonth = new Date(year, month, 0).getDate();
            
            const table = document.getElementById('attendanceTable');
            const thead = table.querySelector('thead tr');
            const tbody = document.getElementById('attendanceBody');
            
            // Limpar e criar cabeçalho
            thead.innerHTML = '<th>Nome</th>';
            for (let day = 1; day <= daysInMonth; day++) {
                const th = document.createElement('th');
                th.textContent = String(day).padStart(2, '0');
                thead.appendChild(th);
            }
            
            // Criar linhas para cada aluno
            tbody.innerHTML = '';
            systemData.students.forEach(student => {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.textContent = student.name;
                row.appendChild(nameCell);
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'attendance-checkbox';
                    checkbox.dataset.studentId = student.id;
                    checkbox.dataset.date = `${year}-${month}-${String(day).padStart(2, '0')}`;
                    
                    // Verificar se já existe presença marcada
                    const attendanceKey = `${student.id}-${year}-${month}-${String(day).padStart(2, '0')}`;
                    if (systemData.attendance[attendanceKey]) {
                        checkbox.checked = true;
                    }
                    
                    dayCell.appendChild(checkbox);
                    row.appendChild(dayCell);
                }
                
                tbody.appendChild(row);
            });
        }

        function saveAttendance() {
            const checkboxes = document.querySelectorAll('.attendance-checkbox');
            checkboxes.forEach(checkbox => {
                const key = `${checkbox.dataset.studentId}-${checkbox.dataset.date}`;
                systemData.attendance[key] = checkbox.checked;
            });
            alert('Presenças salvas com sucesso!');
        }

        function loadPaymentsTab() {
            checkPaymentAlerts();
            updatePaymentsList();
        }

        function checkPaymentAlerts() {
            const alertsDiv = document.getElementById('paymentAlerts');
            alertsDiv.innerHTML = '';
            
            const today = new Date();
            const alertDate = new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000); // 5 dias à frente
            
            systemData.students.forEach(student => {
                // Simular data de vencimento (último dia do mês)
                const dueDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                
                if (dueDate <= alertDate) {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-warning';
                    alert.innerHTML = `
                        <strong>⚠️ Alerta de Vencimento:</strong> ${student.name}<br>
                        Vencimento: ${dueDate.toLocaleDateString('pt-BR')}<br>
                        <button onclick="sendWhatsAppReminder('${student.name}')" class="btn" style="margin-top: 10px; width: auto;">
                            Enviar WhatsApp
                        </button>
                    `;
                    alertsDiv.appendChild(alert);
                }
            });
        }

        function updatePaymentsList() {
            const list = document.getElementById('paymentsList');
            list.innerHTML = '<h4>Status de Mensalidades</h4>';
            
            systemData.students.forEach(student => {
                const paymentDiv = document.createElement('div');
                paymentDiv.className = 'card';
                paymentDiv.innerHTML = `
                    <strong>${student.name}</strong><br>
                    Data Vencimento: ${new Date().toLocaleDateString('pt-BR')}<br>
                    Meses Pagos: <span style="color: green;">3</span><br>
                    Meses a Pagar: <span style="color: red;">1</span>
                `;
                list.appendChild(paymentDiv);
            });
        }

        function sendWhatsAppReminder(studentName) {
            // Simular envio de WhatsApp
            alert(`WhatsApp enviado para ${studentName}: "Não esqueça de pagar sua mensalidade!"`);
        }

        function loadExamsTab() {
            checkExamEligibility();
        }

        function checkExamEligibility() {
            const examsList = document.getElementById('examsList');
            examsList.innerHTML = '<h4>Elegibilidade para Exames</h4>';
            
            systemData.students.forEach(student => {
                const examInfo = beltProgression[student.belt];
                if (!examInfo) return;
                
                const examDate = new Date(student.examDate);
                const today = new Date();
                const monthsDiff = (today.getFullYear() - examDate.getFullYear()) * 12 + (today.getMonth() - examDate.getMonth());
                
                const canTakeExam = monthsDiff >= examInfo.months;
                
                const examDiv = document.createElement('div');
                examDiv.className = 'card';
                examDiv.innerHTML = `
                    <strong>${student.name}</strong><br>
                    Faixa Atual: ${student.belt.charAt(0).toUpperCase() + student.belt.slice(1)}<br>
                    Próxima Faixa: ${examInfo.next.charAt(0).toUpperCase() + examInfo.next.slice(1)}<br>
                    Tempo desde último exame: ${monthsDiff} meses<br>
                    Tempo necessário: ${examInfo.months} meses<br>
                    Valor do Exame: R$ ${examInfo.value.toFixed(2)}<br>
                    <strong>Status: ${canTakeExam ? '<span style="color: green;">PODE FAZER EXAME</span>' : '<span style="color: red;">NÃO PODE FAZER EXAME</span>'}</strong><br>
                    ${canTakeExam ? `
                        <button onclick="approveExam('${student.id}', '${examInfo.next}')" class="btn" style="margin: 5px; width: auto; background: green;">
                            Aprovar
                        </button>
                        <button onclick="scheduleReexam('${student.id}')" class="btn" style="margin: 5px; width: auto; background: orange;">
                            Remarcar
                        </button>
                    ` : ''}
                `;
                examsList.appendChild(examDiv);
            });
        }

        function approveExam(studentId, nextBelt) {
            const student = systemData.students.find(s => s.id == studentId);
            if (student) {
                student.belt = nextBelt;
                student.examDate = new Date().toISOString().split('T')[0];
                
                // Simular geração de diploma em PDF
                generateDiploma(student);
                
                alert(`Exame aprovado! ${student.name} agora possui faixa ${nextBelt}!`);
                checkExamEligibility();
                updateStudentsList();
            }
        }

        function scheduleReexam(studentId) {
            const student = systemData.students.find(s => s.id == studentId);
            if (student) {
                alert(`Exame remarcado para ${student.name}. Novo exame agendado conforme regulamento.`);
            }
        }

        function generateDiploma(student) {
            // Simular geração de diploma
            alert(`Diploma gerado em PDF para ${student.name} - Faixa ${student.belt}!\nEnviando por WhatsApp...`);
        }

        // Funções de Equipamentos e Empréstimos
        function loadEquipmentTab() {
            updateStudentSelects();
            updateAvailableEquipment();
            updateActiveLoans();
            updateLoanHistory();
            updateEquipmentInventory();
            
            // Definir data atual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('loanDate').value = today;
            
            // Definir data de devolução (30 dias depois)
            const returnDate = new Date();
            returnDate.setDate(returnDate.getDate() + 30);
            document.getElementById('returnDate').value = returnDate.toISOString().split('T')[0];
        }

        // Mostrar/ocultar campo de cor da faixa
        document.addEventListener('DOMContentLoaded', function() {
            const equipmentType = document.getElementById('equipmentType');
            if (equipmentType) {
                equipmentType.addEventListener('change', function() {
                    const beltColorGroup = document.getElementById('beltColorGroup');
                    if (this.value === 'faixa') {
                        beltColorGroup.style.display = 'block';
                    } else {
                        beltColorGroup.style.display = 'none';
                    }
                });
            }
        });

        function addEquipment() {
            const type = document.getElementById('equipmentType').value;
            const size = document.getElementById('equipmentSize').value;
            const code = document.getElementById('equipmentCode').value;
            const condition = document.getElementById('equipmentCondition').value;
            const beltColor = document.getElementById('beltColor').value;
            
            if (!code) {
                alert('Código/Número é obrigatório!');
                return;
            }
            
            const equipment = {
                id: Date.now(),
                type: type,
                size: size,
                code: code,
                condition: condition,
                beltColor: type === 'faixa' ? beltColor : null,
                status: 'disponivel',
                createdAt: new Date().toISOString()
            };
            
            systemData.equipment.push(equipment);
            updateAvailableEquipment();
            updateEquipmentInventory();
            clearEquipmentForm();
            alert('Equipamento cadastrado com sucesso!');
        }

        function clearEquipmentForm() {
            document.getElementById('equipmentType').value = 'kimono';
            document.getElementById('equipmentSize').value = 'PP';
            document.getElementById('equipmentCode').value = '';
            document.getElementById('equipmentCondition').value = 'novo';
            document.getElementById('beltColor').value = 'branca';
            document.getElementById('beltColorGroup').style.display = 'none';
        }

        function updateStudentSelects() {
            const select = document.getElementById('loanStudent');
            select.innerHTML = '<option value="">Selecione um aluno</option>';
            
            systemData.students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                select.appendChild(option);
            });
        }

        function updateAvailableEquipment() {
            const select = document.getElementById('availableEquipment');
            select.innerHTML = '<option value="">Selecione um equipamento</option>';
            
            const availableEquipment = systemData.equipment.filter(eq => eq.status === 'disponivel');
            
            availableEquipment.forEach(equipment => {
                const option = document.createElement('option');
                option.value = equipment.id;
                const description = equipment.type === 'faixa' 
                    ? `${equipment.type.charAt(0).toUpperCase() + equipment.type.slice(1)} ${equipment.beltColor} - ${equipment.size} (${equipment.code})`
                    : `${equipment.type.charAt(0).toUpperCase() + equipment.type.slice(1)} - ${equipment.size} (${equipment.code})`;
                option.textContent = description;
                select.appendChild(option);
            });
        }

        function createLoan() {
            const studentId = document.getElementById('loanStudent').value;
            const equipmentId = document.getElementById('availableEquipment').value;
            const loanDate = document.getElementById('loanDate').value;
            const returnDate = document.getElementById('returnDate').value;
            const notes = document.getElementById('loanNotes').value;
            
            if (!studentId || !equipmentId || !loanDate || !returnDate) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            const student = systemData.students.find(s => s.id == studentId);
            const equipment = systemData.equipment.find(e => e.id == equipmentId);
            
            const loan = {
                id: Date.now(),
                studentId: studentId,
                studentName: student.name,
                equipmentId: equipmentId,
                equipmentDescription: equipment.type === 'faixa' 
                    ? `${equipment.type} ${equipment.beltColor} - ${equipment.size} (${equipment.code})`
                    : `${equipment.type} - ${equipment.size} (${equipment.code})`,
                loanDate: loanDate,
                returnDate: returnDate,
                notes: notes,
                status: 'ativo',
                createdAt: new Date().toISOString()
            };
            
            // Marcar equipamento como emprestado
            equipment.status = 'emprestado';
            
            systemData.loans.push(loan);
            updateActiveLoans();
            updateAvailableEquipment();
            updateEquipmentInventory();
            clearLoanForm();
            alert('Empréstimo registrado com sucesso!');
        }

        function clearLoanForm() {
            document.getElementById('loanStudent').value = '';
            document.getElementById('availableEquipment').value = '';
            document.getElementById('loanNotes').value = '';
            
            // Redefinir datas
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('loanDate').value = today;
            
            const returnDate = new Date();
            returnDate.setDate(returnDate.getDate() + 30);
            document.getElementById('returnDate').value = returnDate.toISOString().split('T')[0];
        }

        function updateActiveLoans() {
            const container = document.getElementById('activeLoans');
            const activeLoans = systemData.loans.filter(loan => loan.status === 'ativo');
            
            if (activeLoans.length === 0) {
                container.innerHTML = '<p style="color: #666;">Nenhum empréstimo ativo.</p>';
                return;
            }
            
            container.innerHTML = '';
            activeLoans.forEach(loan => {
                const loanDiv = document.createElement('div');
                loanDiv.className = 'student-item';
                
                const returnDate = new Date(loan.returnDate);
                const today = new Date();
                const isOverdue = returnDate < today;
                
                loanDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong>${loan.studentName}</strong><br>
                            <strong>Equipamento:</strong> ${loan.equipmentDescription}<br>
                            <strong>Empréstimo:</strong> ${new Date(loan.loanDate).toLocaleDateString('pt-BR')}<br>
                            <strong>Devolução:</strong> <span style="color: ${isOverdue ? 'red' : 'green'}">
                                ${returnDate.toLocaleDateString('pt-BR')} ${isOverdue ? '(ATRASADO)' : ''}
                            </span><br>
                            ${loan.notes ? `<strong>Obs:</strong> ${loan.notes}<br>` : ''}
                        </div>
                        <div>
                            <button onclick="returnEquipment(${loan.id})" class="btn" style="background: green; width: auto; margin: 5px;">
                                Devolver
                            </button>
                            ${isOverdue ? `
                                <button onclick="sendReturnReminder('${loan.studentName}')" class="btn" style="background: orange; width: auto; margin: 5px;">
                                    Lembrete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(loanDiv);
            });
        }

        function returnEquipment(loanId) {
            const loan = systemData.loans.find(l => l.id === loanId);
            if (!loan) return;
            
            // Marcar empréstimo como devolvido
            loan.status = 'devolvido';
            loan.returnedAt = new Date().toISOString();
            
            // Marcar equipamento como disponível
            const equipment = systemData.equipment.find(e => e.id == loan.equipmentId);
            if (equipment) {
                equipment.status = 'disponivel';
            }
            
            updateActiveLoans();
            updateAvailableEquipment();
            updateLoanHistory();
            updateEquipmentInventory();
            alert('Equipamento devolvido com sucesso!');
        }

        function sendReturnReminder(studentName) {
            alert(`Lembrete enviado via WhatsApp para ${studentName}: "Lembre-se de devolver o equipamento da academia!"`);
        }

        function updateLoanHistory() {
            const container = document.getElementById('loanHistory');
            const returnedLoans = systemData.loans.filter(loan => loan.status === 'devolvido');
            
            if (returnedLoans.length === 0) {
                container.innerHTML = '<p style="color: #666;">Nenhum empréstimo no histórico.</p>';
                return;
            }
            
            container.innerHTML = '';
            returnedLoans.slice(-10).reverse().forEach(loan => { // Mostrar últimos 10
                const loanDiv = document.createElement('div');
                loanDiv.className = 'student-item';
                loanDiv.style.opacity = '0.8';
                
                loanDiv.innerHTML = `
                    <strong>${loan.studentName}</strong><br>
                    <strong>Equipamento:</strong> ${loan.equipmentDescription}<br>
                    <strong>Empréstimo:</strong> ${new Date(loan.loanDate).toLocaleDateString('pt-BR')}<br>
                    <strong>Devolução:</strong> ${new Date(loan.returnedAt).toLocaleDateString('pt-BR')}<br>
                    ${loan.notes ? `<strong>Obs:</strong> ${loan.notes}<br>` : ''}
                `;
                container.appendChild(loanDiv);
            });
        }

        function updateEquipmentInventory() {
            const container = document.getElementById('equipmentInventory');
            
            if (systemData.equipment.length === 0) {
                container.innerHTML = '<p style="color: #666;">Nenhum equipamento cadastrado.</p>';
                return;
            }
            
            // Agrupar por tipo e status
            const inventory = {};
            systemData.equipment.forEach(equipment => {
                const key = equipment.type;
                if (!inventory[key]) {
                    inventory[key] = { disponivel: 0, emprestado: 0, total: 0 };
                }
                inventory[key][equipment.status]++;
                inventory[key].total++;
            });
            
            container.innerHTML = '<h5>Resumo do Inventário</h5>';
            
            Object.keys(inventory).forEach(type => {
                const stats = inventory[type];
                const inventoryDiv = document.createElement('div');
                inventoryDiv.className = 'student-item';
                inventoryDiv.innerHTML = `
                    <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong><br>
                    Total: ${stats.total} | 
                    <span style="color: green;">Disponível: ${stats.disponivel}</span> | 
                    <span style="color: orange;">Emprestado: ${stats.emprestado}</span>
                `;
                container.appendChild(inventoryDiv);
            });
            
            // Lista detalhada
            const detailDiv = document.createElement('div');
            detailDiv.innerHTML = '<h5 style="margin-top: 20px;">Lista Detalhada</h5>';
            container.appendChild(detailDiv);
            
            systemData.equipment.forEach(equipment => {
                const equipDiv = document.createElement('div');
                equipDiv.className = 'student-item';
                equipDiv.style.borderLeftColor = equipment.status === 'disponivel' ? '#28a745' : '#ffc107';
                
                const description = equipment.type === 'faixa' 
                    ? `${equipment.type} ${equipment.beltColor} - ${equipment.size}`
                    : `${equipment.type} - ${equipment.size}`;
                
                equipDiv.innerHTML = `
                    <strong>${description}</strong> (${equipment.code})<br>
                    <strong>Estado:</strong> ${equipment.condition}<br>
                    <strong>Status:</strong> <span style="color: ${equipment.status === 'disponivel' ? 'green' : 'orange'}">
                        ${equipment.status === 'disponivel' ? 'Disponível' : 'Emprestado'}
                    </span>
                `;
                container.appendChild(equipDiv);
            });
        }

        function loadSystemData() {
            // Inicializar dados do sistema
            document.getElementById('academyName').textContent = systemData.academy.name || 'Academia de Karatê';
            updateStudentsList();
            
            // Definir mês atual no controle de presenças
            const currentDate = new Date();
            const currentMonth = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0');
            document.getElementById('attendanceMonth').value = currentMonth;
        }
    </script>
</body>
